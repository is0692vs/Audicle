name: Update Project Health Report

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 5'  # æ¯Žé€±é‡‘æ›œæ—¥ 9æ™‚ï¼ˆJSTï¼‰
  workflow_dispatch:

jobs:
  update-health:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for script
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd packages/web-app-vercel
          npm ci

      - name: Run tests with coverage
        run: |
          cd packages/web-app-vercel
          npm test -- --coverage --json --outputFile=coverage.json
        continue-on-error: true

      - name: Generate PROJECT_HEALTH.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          mkdir -p docs

          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿å–å¾—
          if [ -f packages/web-app-vercel/coverage/coverage-summary.json ]; then
            STMT=$(jq -r '.total.statements.pct' packages/web-app-vercel/coverage/coverage-summary.json)
            BRANCH=$(jq -r '.total.branches.pct' packages/web-app-vercel/coverage/coverage-summary.json)
            FUNC=$(jq -r '.total.functions.pct' packages/web-app-vercel/coverage/coverage-summary.json)
            LINES=$(jq -r '.total.lines.pct' packages/web-app-vercel/coverage/coverage-summary.json)
          else
            STMT="N/A"
            BRANCH="N/A"
            FUNC="N/A"
            LINES="N/A"
          fi

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
          NEXT=$(jq -r '.dependencies.next // "N/A"' packages/web-app-vercel/package.json)
          REACT=$(jq -r '.dependencies.react // "N/A"' packages/web-app-vercel/package.json)
          TS=$(jq -r '.devDependencies.typescript // "N/A"' packages/web-app-vercel/package.json)

          # GitHubçµ±è¨ˆå–å¾— via API
          API_URL="https://api.github.com/repos/$GITHUB_REPOSITORY"
          REPO_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL")
          STARS=$(echo "$REPO_JSON" | jq -r '.stargazers_count // "0"')
          ISSUES=$(echo "$REPO_JSON" | jq -r '.open_issues_count // "0"')

          # PRã¨ã‚³ãƒŸãƒƒãƒˆæ•°å–å¾—
          PRS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/pulls?state=open" | jq 'length')
          COMMITS=$(git log --since="30 days ago" --oneline | wc -l | tr -d '[:space:]')

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹å–å¾—
          WORKFLOW_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/actions/runs?per_page=3")
          WORKFLOWS=$(echo "$WORKFLOW_JSON" | jq -c '[.workflow_runs[] | {name: .name, status: .conclusion, updated: .updated_at}]')

# PROJECT_HEALTH.mdç”Ÿæˆ
          cat > docs/PROJECT_HEALTH.md << 'EOF'
# ðŸ“Š Audicle - Project Health Report

Last Updated: $TIMESTAMP (Auto-generated)

## ðŸ§ª Test Coverage

| Category | Coverage |
|----------|----------|
| Statements | ${STMT}% |
| Branches | ${BRANCH}% |
| Functions | ${FUNC}% |
| Lines | ${LINES}% |

## ðŸ“¦ Technology Stack

| Package | Version |
|---------|---------|
| Next.js | ${NEXT} |
| React | ${REACT} |
| TypeScript | ${TS} |

## ðŸ“ˆ Repository Stats

- â­ Stars: ${STARS}
- ðŸ› Open Issues: ${ISSUES}
- ðŸ”€ Open PRs: ${PRS}
- ðŸ“ Commits (30 days): ${COMMITS}

## ðŸš€ Recent CI/CD Runs

<!-- Auto-generated workflow status -->

# __WORKFLOWS_PLACEHOLDER__

---

*This report is automatically updated by GitHub Actions.*
*Last workflow run: [View Details]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions)*
EOF

          # ç’°å¢ƒå¤‰æ•°ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ› (ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¯ sed ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨)
          sed -i "s/\$TIMESTAMP/$TIMESTAMP/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${STMT}/$STMT/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${BRANCH}/$BRANCH/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${FUNC}/$FUNC/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${LINES}/$LINES/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${NEXT}/$NEXT/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${REACT}/$REACT/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${TS}/$TS/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${STARS}/$STARS/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${ISSUES}/$ISSUES/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${PRS}/$PRS/g" docs/PROJECT_HEALTH.md
          sed -i "s/\${COMMITS}/$COMMITS/g" docs/PROJECT_HEALTH.md
          sed -i "s|\$GITHUB_SERVER_URL/\$GITHUB_REPOSITORY|$GITHUB_SERVER_URL/$GITHUB_REPOSITORY|g" docs/PROJECT_HEALTH.md

          # Workflowsã‚’ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¿½è¨˜
          printf "\n\`\`\`json\n%s\n\`\`\`\n" "$WORKFLOWS" >> docs/PROJECT_HEALTH.md
          sed -i "s/__WORKFLOWS_PLACEHOLDER__//g" docs/PROJECT_HEALTH.md

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to docs/PROJECT_HEALTH.md"
            exit 0
          fi

          git add docs/PROJECT_HEALTH.md
          git commit -m "docs: update PROJECT_HEALTH.md [skip ci]" || echo "Commit failed"
          git push
