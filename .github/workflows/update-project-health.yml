name: Update Project Health Report

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 5'  # æ¯é€±é‡‘æ›œæ—¥ 9æ™‚ï¼ˆJSTï¼‰
  workflow_dispatch:

jobs:
  update-health:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for script
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          cd packages/web-app-vercel
          npm ci

      - name: Run tests with coverage
        run: |
          cd packages/web-app-vercel
          npm test -- --coverage --json --outputFile=coverage.json
        continue-on-error: true

      - name: Generate PROJECT_HEALTH.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          mkdir -p docs

          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿å–å¾—
          if [ -f packages/web-app-vercel/coverage/coverage-summary.json ]; then
            STMT=$(jq -r '.total.statements.pct' packages/web-app-vercel/coverage/coverage-summary.json)
            BRANCH=$(jq -r '.total.branches.pct' packages/web-app-vercel/coverage/coverage-summary.json)
            FUNC=$(jq -r '.total.functions.pct' packages/web-app-vercel/coverage/coverage-summary.json)
            LINES=$(jq -r '.total.lines.pct' packages/web-app-vercel/coverage/coverage-summary.json)
          else
            STMT="N/A"
            BRANCH="N/A"
            FUNC="N/A"
            LINES="N/A"
          fi

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
          NEXT=$(jq -r '.dependencies.next // "N/A"' packages/web-app-vercel/package.json)
          REACT=$(jq -r '.dependencies.react // "N/A"' packages/web-app-vercel/package.json)
          TS=$(jq -r '.devDependencies.typescript // "N/A"' packages/web-app-vercel/package.json)

          # GitHubçµ±è¨ˆå–å¾— via API
          API_URL="https://api.github.com/repos/$GITHUB_REPOSITORY"
          REPO_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL")
          STARS=$(echo "$REPO_JSON" | jq -r '.stargazers_count // "0"')
          ISSUES=$(echo "$REPO_JSON" | jq -r '.open_issues_count // "0"')

          # PRã¨ã‚³ãƒŸãƒƒãƒˆæ•°å–å¾—
          PRS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/pulls?state=open" | jq 'length')
          COMMITS=$(git log --since="30 days ago" --oneline | wc -l | tr -d '[:space:]')

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹å–å¾—
          WORKFLOW_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/actions/runs?per_page=3")
          WORKFLOWS=$(echo "$WORKFLOW_JSON" | jq -c '[.workflow_runs[] | {name: .name, status: .conclusion, updated: .updated_at}]')

          # PROJECT_HEALTH.mdç”Ÿæˆ
          {
            echo "# ğŸ“Š Audicle - Project Health Report"
            echo ""
            echo "Last Updated: $TIMESTAMP (Auto-generated)"
            echo ""
            echo "## ğŸ§ª Test Coverage"
            echo ""
            echo "| Category | Coverage |"
            echo "|----------|----------|"
            echo "| Statements | ${STMT}% |"
            echo "| Branches | ${BRANCH}% |"
            echo "| Functions | ${FUNC}% |"
            echo "| Lines | ${LINES}% |"
            echo ""
            echo "## ğŸ“¦ Technology Stack"
            echo ""
            echo "| Package | Version |"
            echo "|---------|---------|"
            echo "| Next.js | ${NEXT} |"
            echo "| React | ${REACT} |"
            echo "| TypeScript | ${TS} |"
            echo ""
            echo "## ğŸ“ˆ Repository Stats"
            echo ""
            echo "- â­ Stars: ${STARS}"
            echo "- ğŸ› Open Issues: ${ISSUES}"
            echo "- ğŸ”€ Open PRs: ${PRS}"
            echo "- ğŸ“ Commits (30 days): ${COMMITS}"
            echo ""
            echo "## ğŸš€ Recent CI/CD Runs"
            echo ""
            echo "<!-- Auto-generated workflow status -->"
            echo ""
            echo "__WORKFLOWS_PLACEHOLDER__"
            echo ""
            echo "---"
            echo ""
            echo "*This report is automatically updated by GitHub Actions.*"
            echo "*Last workflow run: [View Details]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions)*"
          } > docs/PROJECT_HEALTH.md

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¿½è¨˜
          printf "\n\`\`\`json\n%s\n\`\`\`\n" "$WORKFLOWS" >> docs/PROJECT_HEALTH.md
          sed -i "s/__WORKFLOWS_PLACEHOLDER__//g" docs/PROJECT_HEALTH.md          # Workflowsã‚’ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¿½è¨˜
          printf "\n\`\`\`json\n%s\n\`\`\`\n" "$WORKFLOWS" >> docs/PROJECT_HEALTH.md
          printf "\n\`\`\`json\n%s\n\`\`\`\n" "$WORKFLOWS" >> docs/PROJECT_HEALTH.md
          sed -i "s/__WORKFLOWS_PLACEHOLDER__//g" docs/PROJECT_HEALTH.md

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to docs/PROJECT_HEALTH.md"
            exit 0
          fi

          git add docs/PROJECT_HEALTH.md
          git commit -m "docs: update PROJECT_HEALTH.md [skip ci]" || echo "Commit failed"
          git push
