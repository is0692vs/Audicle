name: Localize Dependabot PR - Add Japanese Comment

on:
  workflow_call:
    inputs:
      pr_number:
        type: string
        required: true
      pr_title:
        type: string
        required: true
      pr_body:
        type: string
        required: true
      pr_url:
        type: string
        required: true
      pr_base_ref:
        type: string
        required: true
    secrets:
      GITHUB_TOKEN:
        required: true

permissions:
  pull-requests: write
  contents: read

jobs:
  add_localized_comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout base branch (secure)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_base_ref }}
      - name: Prepare template variables
        id: prepare_vars
        run: |
          cat <<EOF > vars.yaml
          title: "${{ inputs.pr_title }}"
          pr_url: "${{ inputs.pr_url }}"
          package_list: "依存更新の詳細はPR本文をご参照ください"
          EOF
          
          # expose the vars.yaml content as a step output for the template action
          echo "vars<<EOF" >> $GITHUB_OUTPUT
          cat vars.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Render template
        id: render_vars
        uses: chuhlomin/render-template@v1.4
        with:
          template: .github/dependabot-templates/jp-dependabot-comment.md
          vars: "${{ steps.prepare_vars.outputs.vars }}"
        # render-template runs from the repo default branch, which is secure

      - name: Find existing localization comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ inputs.pr_number }}
          comment-author: 'github-actions[bot]'
          body-includes: '依存関係の更新（自動）'

      - name: Create localized comment
        if: steps.find_comment.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ inputs.pr_number }}
          body: ${{ steps.render_vars.outputs.result }}

      - name: Skip if Japanese comment exists
        if: steps.find_comment.outputs.comment-id != ''
        run: echo "A Japanese localization comment already exists. Skipping." 
